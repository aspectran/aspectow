<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="rooms">

	<resultMap id="roomInfoMap" type="club.textchat.room.RoomInfo">
		<result property="roomId" column="room_id" />
		<result property="roomName" column="room_nm" />
		<result property="language" column="lang_cd" />
		<result property="cumulativeUsers" column="cumu_users" />
		<result property="currentUsers" column="curr_users" />
		<result property="pastDays" column="past_days" />
	</resultMap>

	<select id="getRoomInfo" parameterType="string" resultMap="roomInfoMap">
		select
		    room_id,
		    room_nm,
		    lang_cd
		from rooms
		where room_id = #{roomId}
	</select>

	<select id="getRoomList" resultMap="roomInfoMap">
		select
			room_id,
			room_nm,
			cumu_users,
			curr_users,
			datediff(now(), reg_dt) as past_days
		from rooms
		order by if(past_days &lt;= 1, 1, 2), curr_users desc, cumu_users desc
		limit 99
	</select>

	<select id="getRoomCountByName" parameterType="string" resultType="int">
		select count(1) from rooms where room_nm = #{roomId}
	</select>

    <insert id="insertRoom" parameterType="club.textchat.room.RoomInfo" useGeneratedKeys="true" keyProperty="roomId">
        insert into rooms (room_nm, lang_cd, user_no) values (#{roomName}, #{language}, #{userNo})
    </insert>

	<update id="updateRoomForCheckIn" parameterType="string">
        update rooms set
        	cumu_users = cumu_users + 1,
        	curr_users = curr_users + 1,
        	used_dt = now()
        where room_id = #{roomId}
    </update>

	<update id="updateRoomForCheckOut" parameterType="string">
        update rooms set
        	curr_users = curr_users - 1,
        	used_dt = now()
        where room_id = #{roomId}
        	and curr_users &gt; 0
    </update>

</mapper>